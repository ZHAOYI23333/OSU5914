<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>FriendFinder</title>

  <!-- Bootstrap core CSS -->
  <link href="static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
<link href="static/css/simple-sidebar.css" rel="stylesheet">

  <!-- Custom fonts -->
  <link href="https://fonts.googleapis.com/css?family=Lobster&display=swap" rel="stylesheet">

  <!-- Custom styles -->
  <link href="static/css/custom.css" rel="stylesheet">

</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand navbar-brand-custom" href="#">FriendFinder</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
        <li class="nav-item active">
          <a class="nav-link" href="#">Home<span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="#">Find by interests<span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="#">Wingman dating<span class="sr-only">(current)</span></a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="d-flex" id="wrapper">
    <!-- Page Content -->
    <div id="page-content-wrapper">

      <div class="jumbotron jumbotron-fluid jumbotron-custom">
        <div class="container">
          <h1 class="display-4 jumbotron-font">Find your friends.</h1>
          <p class="lead jumbotron-font-secondary">Find nearby friends.</p>
        </div>
        <div class="container info-input-container">
          <div class="panel panel-default">
            <label class="text-light" for="exampleInputEmail1">Your Twitter Info</label>
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text" id="basic-addon1">@</span>
              </div>
              <input type="text" id="twitter-handle-input" class="form-control" placeholder="Username"
                aria-label="emailHelp">
            </div>
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text" id="basic-addon2">Location</span>
              </div>
              <input type="text" id="location-input" class="form-control" placeholder="Columbus, OH"
                aria-label="Location">
            </div>
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text" id="basic-addon3">Radius</span>
              </div>
              <label id="radius-label" aria-label="Radius">50km</label>
              <input type="range" min="2" max="100" value="50" class="form-control slider" id="radius-range">
            </div>
            <button type="submit" class="btn btn-primary btn-block" id="twitter-handle-submit-btn">Find Friends</button>
            <small id="emailHelp" class="text-light">Find nearby twitter accounts with similar
              interests.</small>
          </div>
        </div>
      </div>

      <button class="btn btn-secondary" id="map-toggle-button" style="margin-top: 15px; margin-bottom: 10px;">Toggle
        Map</button>
      <div id="map" class="map" style="height: 300px;"></div>

      <div class="container-fluid interests-container bg-light border-bottom">
          <h1 class="display-5">Interests</h1>
          <p class="text-muted">In order of confidence</p>
          <p class="text-muted">Nothing yet!</p>
        <br><br>
        <h3>Interests Detected (in order of confidence):</h3>
        <br>
        <br>
        <h3>Nearby Twitter Accounts:</h3>
        <table class="table" id="friend-table">
          <thead>
            <tr>
              <th scope="col">Match Score</th>
              <th scope="col">Handle</th>
              <th scope="col">Profile Pic</th>
              <th scope="col">Similar Interests</th>
            </tr>
          </thead>
          <tbody id="friend-table-body">
          </tbody>
        </table>
      </div>

    </div>
    <!-- /#page-content-wrapper -->

  </div>

  <style>
    #radius-label {
      margin-left: 10px;
      margin-top: 5px;
      font-size: 8;
      color: gray;
      margin-left: 5px;
    }

    .marker-overlay {
      margin-top: -200%;
      margin-left: -50%;
    }

    .slider {
      margin-top: 10px;
      margin-left: 10px;
      margin-right: 10px;
      -webkit-appearance: none;
      width: 80%;
      height: 15px;
      border-radius: 5px;   
      background: #d3d3d3;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 25px;
      height: 25px;
      border-radius: 50%; 
      background:steelblue;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background:steelblue;
      cursor: pointer;
    }
  </style>

  <!-- /#wrapper -->

  <!-- Bootstrap core JavaScript -->
  <script src="static/vendor/jquery/jquery.min.js"></script>
  <script src="static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Menu Toggle Script -->
  <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v6.0.1/build/ol.js"></script>
  <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v6.0.1/css/ol.css">
  <script type="text/javascript">
    document.getElementById('radius-range').oninput = () => {
      document.getElementById('radius-label').innerHTML = $('#radius-range').val() + 'km';
    }

    var map = new ol.Map({
      target: 'map',
      layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
      view: new ol.View({ center: ol.proj.fromLonLat([-82.87, 40]), zoom: 2})
    });

    map.on('click', (e) => {
      $('.marker-overlay').remove();

      var lonlat = ol.coordinate.createStringXY(4)(ol.proj.toLonLat(e.coordinate));
      var coords = lonlat.split(', ');
      $('#location-input').val([coords[1], coords[0]].join(','));

      var marker = document.createElement('img');
      marker.setAttribute('src', 'static/img/marker.png');
      marker.setAttribute('width', '27.5');
      marker.setAttribute('height', '45');
      marker.className = 'marker-overlay';

      map.addOverlay(new ol.Overlay({
        position: ol.proj.transform(ol.proj.toLonLat(e.coordinate), 'EPSG:4326', 'EPSG:3857'),
        element: marker
      }));
    })

    var mapActive = true;

    $('#map-toggle-button').click(() => {
      var newH = 0;
      if (!mapActive) newH = 300;
      $('#map').height(newH);
      mapActive = !mapActive;
    })

    function getInterests(handle, callback) {
      $.getJSON('/interests/' + handle, (data, status) => {
        if (status !== "success") {
          alert('Could\'nt get your interests. Sorry');
          return;
        }

        callback(data);
      })
    }

    function displayInterests(interests) {
      let interestDiv = $('#self-interests-div');
      var value, self_interest_list;
      interestDiv.empty();
      Object.keys(interests).forEach(function (key) {
        value = interests[key] + '';
        self_interest_list = value.split(',');
        self_interest_list.forEach(function (interest) {
          var intP = document.createElement('span');
          intP.className = 'badge badge-pill badge-interests badge-info';
          intP.innerHTML = interest;
          interestDiv.append(intP);
        });
      });

    }

    function displayFriend(idx, handle, score, interests, image) {
      let friendDiv = $('#friend-table-body');

      var frRow = document.createElement('tr');

      var frScope = document.createElement('th');
      frScope.setAttribute('scope', 'row');
      frScope.innerHTML = idx;

      var frHandle = document.createElement('td');
      frHandle.innerHTML = handle;

      var frScore = document.createElement('td');
      frScope.innerHTML = score.toFixed(3);

      var frInt = document.createElement('td');
      frInt.innerHTML = interests.join(', ');

      var frImage = document.createElement('td');

      if (image!="no image"){
        var frImagePic = document.createElement('img');
        frImagePic.src = image;
        frImagePic.height = '100';
        frImagePic.width = '100';
        frImage.appendChild(frImagePic);
      }

      frRow.append(frScope, frHandle, frImage, frInt);
      friendDiv.append(frRow);
    }

    function displayFriends(friends) {
      for (var i = 0; i < friends.length; i++)
        displayFriend(i, friends[i]['handle'], friends[i]['score'], friends[i]['interests'], friends[i]['image']);
    }

    $("#menu-toggle").click(function (e) {
      e.preventDefault();
      $("#wrapper").toggleClass("toggled");
    });

    $('#twitter-handle-submit-btn').click(() => {
      let handle = $('#twitter-handle-input').val();
      let location = $('#location-input').val();
      let radius = $('#radius-range').val();

      let interestDiv = document.getElementById('self-interests-div');
      while (interestDiv.firstChild)
        interestDiv.removeChild(interestDiv.firstChild);

      let friendDiv = document.getElementById('friend-table-body');
      while (friendDiv.firstChild)
        friendDiv.removeChild(friendDiv.firstChild);

      $.post('/user/' + encodeURIComponent(handle) + '?location_arg=' + encodeURIComponent(location) + '&radius=' + encodeURIComponent(radius), (data, status, xhr) => {
        if (status !== "success") {
          alert('Couldn\'t upload you into our database. Sorry');
          return;
        }

        $.getJSON('/friends_and_interests/' + encodeURIComponent(handle) + '/' + encodeURIComponent(location), (friends_and_interests, status) => {
          if (status !== "success") {
            alert('Couldn\'t get your friends. Sorry');
            return;
          }

          friends = friends_and_interests.friends;
          interests = friends_and_interests.interests;

          displayInterests(interests);
          displayFriends(friends);
        });
      })
    })
  </script>

</body>

</html>